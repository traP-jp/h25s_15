# flow

## プレイの流れ

1. ユーザーはトップページにアクセスする
2. ユーザーは「ゲームを始める」ボタンを押す
   1. クライアントはサーバーに新しいゲームの開始をリクエストする。(`createGame`)
   2. クライアントはサーバーからゲームの情報を受け取るまで、待機する (`waitGameWS`)
   3. サーバーはユーザーが他のユーザーとマッチしたら、ゲームの情報をクライアントに送信する
   4. クライアントはゲームの情報を受け取ったら、ゲーム画面に遷移する
3. ユーザーはゲームをプレイする
4. ゲームが終了したら、クライアントは結果の画面を表示する

## ゲームの流れ

1. サーバーは、対戦する二人のユーザーのクライアントにゲームのIDとプレイヤーIDを通知する。(`waitGameWS` でマッチング成立イベント送信)
   1. クライアントは、通知された情報をもとにゲーム画面を表示する。(`gameWS` に接続)
2. 2つのクライアントがゲーム画面に接続したら、サーバーはゲームの初期状態を両クライアントに送信する。(`gameReady` イベント)
   1. クライアントは受け取った情報をもとに画面を更新する。
3. サーバーは、ゲームの開始を両クライアントに通知する (`gameStarted` イベント)
   1. クライアントは、通知された情報をもとにゲーム画面を表示する。
4. ゲームはターン制で進行する。詳細は [ゲームのターンの流れ](#ゲームのターンの流れ)を参照。
5. ゲームが終了したら、サーバーは両クライアントにゲームの終了を通知する。 (`gameEnded` イベント)
6. クライアントは、ゲームの結果をサーバーにリクエストする。 (`getGameResult`)
   1. サーバーは、ゲームの結果をクライアントに送信する。
   2. クライアントは、受け取った情報をもとに結果画面を表示する。

## ゲームのターンの流れ

player は、自分のターンの間、以下の行動をとることができる。

1. field cardsから1枚クリックして選んで(pick)、hand cards に加える
   1. クライアントはサーバーに選ばれたカードの情報を送信する。(`pickCard`)
   2. サーバーは、hand cardsの上限に達していなければ、選ばれたカードを hand cards に加える。上限に達している場合は、エラーを返す。
   3. サーバーは新しいカードを field cards に追加する
   4. サーバーは新しい hand cards と field cards の状態を、両 player のクライアントに送信する (`cardsUpdated` イベント)
   5. クライアントは表示を更新する
2. hand cards から item card を1枚選んで、その効果を使う (`useItem`)
   1. クライアントは、使用されたカードの情報をサーバーに送信する
   2. サーバーは、使用されたカードの効果を適用し、hand cards と field cards の状態を両 player のクライアントに送信する (`cardsUpdated` イベント)
   3. クライアントは表示を更新する
3. hand cards もしくは `(`、`)` ボタンから1つクリックして選んで、式を構成する
   1. クライアントは、現在の式が表す値を計算する
   2. クライアントは表示を更新する
   3. クライアントはサーバーに情報を送信しない
4. 送信ボタンを押す
   1. クライアントは、現在の式と使用した hand cards の情報をサーバーに送信する。(`submitExpression`)
   2. サーバーは現在の式を評価し、10であることを確かめる。10でなかった場合は、エラーを返す。10であった場合は、両 player に expression を送信する (`submissionSucceeded` イベント)
   3. サーバーは使用されたカードの情報を保存し、hand cards と field cards の状態を両 player のクライアントに送信する (`cardsUpdated` イベント)
   4. サーバーは player の得点を加算し、現在の得点を両 player のクライアントに送信する (`scoreUpdated` イベント)
   5. クライアントは表示を更新する
5. expression を delete する
   1. クライアントは、現在の式を削除する
   2. クライアントは表示を更新する
   3. クライアントはサーバーに情報を送信しない
6. 自分の hand cards をclearする (`clearHandCards`)
   1. クライアントは、サーバーに hand cards をクリアするリクエストを送信する
   2. サーバーは hand cards をクリアし、両 player のクライアントに hand cards の状態を送信する (`cardsUpdated` イベント)
   3. サーバーは、clearしたplayerのscoreを3減らし、両 player のクライアントに現在の得点を送信する (`scoreUpdated` イベント)
   4. クライアントは表示を更新する

turn time remaining はサーバーが管理し、クライアントはその情報を表示するだけとする (`turnTimeRemainingChanged` イベント)。turn time remaining が 0 になったら、サーバーは両 player のクライアントにターン終了の通知を送信する (`turnEnded` イベント)。
